name: Preview Deploy

on:
  pull_request:
    paths:
      - "67dle-frontend/**"
      - "67dle-workers/**"
      - ".github/workflows/preview.yml"

jobs:
  preview:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: oven-sh/setup-bun@v2

      - name: Install worker deps
        working-directory: 67dle-workers
        run: bun install

      - name: Deploy worker preview
        working-directory: 67dle-workers
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        run: |
          DEPLOY_JSON=$(bunx wrangler deploy --env preview --name 67dle-workers-pr-${{ github.event.pull_request.number }} --json)
          echo "${DEPLOY_JSON}" > /tmp/worker-deploy.json
          WORKER_URL=$(node -e "const fs=require('fs');const data=JSON.parse(fs.readFileSync('/tmp/worker-deploy.json','utf8'));console.log(data?.workers_dev ?? '')")
          if [ -z "${WORKER_URL}" ]; then
            echo "Failed to read workers_dev from deploy output" >&2
            exit 1
          fi
          echo "WORKER_URL=${WORKER_URL}" >> "$GITHUB_ENV"

      - name: Generate seed SQL (preview)
        working-directory: 67dle-workers
        run: python scripts/build-word-seed.py

      - name: Apply schema (preview)
        working-directory: 67dle-workers
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        run: bunx wrangler d1 execute 67dle-words-preview --remote --file sql/words.sql

      - name: Seed words (preview)
        working-directory: 67dle-workers
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        run: bunx wrangler d1 execute 67dle-words-preview --remote --file sql/seed_words.sql

      - name: Install frontend deps
        working-directory: 67dle-frontend
        run: bun install

      - name: Build frontend (preview)
        working-directory: 67dle-frontend
        env:
          VITE_API_BASE: ${{ env.WORKER_URL }}
        run: bun run build

      - name: Deploy Pages preview
        working-directory: 67dle-frontend
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        run: bunx wrangler pages deploy dist --project-name 67dle-frontend --branch ${{ github.head_ref }}
